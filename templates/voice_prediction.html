<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acoustic Analysis & Voice Biomarkers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: "Inter", sans-serif; background-color: #f4f6f8; }
        .tool-container { max-width: 800px; margin: 40px auto; padding: 40px; background: #ffffff; border-radius: 16px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08); text-align: center; }
        .tool-icon { font-size: 3rem; color: #1d4ed8; margin-bottom: 20px; }
        .result-box { margin-top: 30px; padding: 30px; border: 1px solid #e0e7ff; border-radius: 12px; text-align: left; background-color: #f9fbff; min-height: 250px; }
        .recording-area { padding: 30px; border: 2px dashed #93c5fd; border-radius: 12px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .record-btn { transition: all 0.2s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .record-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); }
        .status-low { background-color: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-medium { background-color: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .status-high { background-color: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status-error { color: #dc2626; font-weight: 700; }
        .loading-ring { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .recording { color: #ef4444; font-weight: 700; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.5; } }
        .gauge-wrapper { position: relative; width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 5px; }
        .gauge-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease-out; }
    </style>
</head>

<body>
    <main class="container mx-auto">
        <div class="tool-container">
            <div class="tool-icon">
                <i class="fas fa-microphone-alt text-indigo-700"></i>
            </div>
            <h2 class="text-3xl font-extrabold text-gray-800">Clinical Voice Biomarker Analysis</h2>
            <p class="text-gray-500 mb-6">Utilizing eGeMAPS features to analyze voice quality in real-time.</p>

            <div class="prompt-box mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                <p class="font-bold mb-2 text-gray-800">Speaking Task:</p>
                <p id="currentPrompt" class="text-gray-700 italic">Loading prompt...</p>
                <p class="mt-2 text-xs text-indigo-700 font-medium">Aim for <strong>minimum 30 seconds</strong> of speech.</p>
                <button id="newPromptButton" class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs py-1 px-3 mt-3 rounded-full">
                    <i class="fas fa-redo mr-1"></i> New Prompt
                </button>
            </div>

            <div class="recording-area">
                <p id="statusMessage" class="font-medium text-gray-600">Press Record to begin.</p>
                <p id="timerDisplay" class="font-bold text-lg text-gray-700">Time: 00:00</p>

                <div class="w-full text-left">
                    <label class="text-sm font-medium text-gray-600">Live Captions:</label>
                    <textarea id="liveCaptionsBox" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-sm mt-1 focus:ring-2 focus:ring-indigo-400 outline-none" rows="3" readonly placeholder="Your speech will appear here..."></textarea>
                </div>

                <div id="controls" class="flex space-x-4">
                    <button id="recordButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full record-btn">
                        <i class="fas fa-microphone mr-2"></i> Record
                    </button>
                    <button id="stopButton" class="bg-gray-400 text-white font-bold py-3 px-8 rounded-full record-btn" disabled>
                        <i class="fas fa-stop mr-2"></i> Stop & Analyze
                    </button>
                </div>
            </div>

            <div class="result-box">
                <div id="loadingSpinner" class="hidden flex-col items-center justify-center py-4">
                    <div class="loading-ring mb-2"></div>
                    <p class="text-indigo-600 font-semibold">Analyzing voice biomarkers...</p>
                </div>

                <div id="predictionHeader" class="hidden p-4 rounded-xl mb-4 flex items-center justify-between">
                    <span class="text-lg font-bold">Result: <span id="predictedStatus"></span></span>
                    <span class="text-lg font-bold">Confidence: <span id="predictedConfidence">--</span>%</span>
                </div>

                <div id="biomarkerAnalysis" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-3 bg-white border rounded-lg">
                            <p class="text-sm font-medium flex justify-between">Pitch Variability <span id="f0StdValue" class="font-bold text-blue-600">-- Hz</span></p>
                            <div class="gauge-wrapper"><div id="f0StdGauge" class="gauge-bar bg-blue-500" style="width: 0%"></div></div>
                        </div>
                        <div class="p-3 bg-white border rounded-lg">
                            <p class="text-sm font-medium flex justify-between">Loudness/Energy <span id="energyMeanValue" class="font-bold text-green-600">-- dB</span></p>
                            <div class="gauge-wrapper"><div id="energyMeanGauge" class="gauge-bar bg-green-500" style="width: 0%"></div></div>
                        </div>
                    </div>
                </div>

                <div id="initialMessage" class="text-center text-gray-400 italic">Results will appear here after analysis.</div>
                <div id="resultBox" class="mt-4"></div>

            </div>
        </div>
    </main>

    <script type="module">
        const resultBox = document.getElementById("resultBox");

        const MIN_DURATION = 30;
        let mediaRecorder, audioChunks = [], isRecording = false, startTime = 0, timerInterval, recognition;

        const recordButton = document.getElementById("recordButton");
        const stopButton = document.getElementById("stopButton");
        const statusMessage = document.getElementById("statusMessage");
        const timerDisplay = document.getElementById("timerDisplay");
        const liveCaptionsBox = document.getElementById("liveCaptionsBox");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const predictionHeader = document.getElementById("predictionHeader");
        const biomarkerAnalysis = document.getElementById("biomarkerAnalysis");
        const initialMessage = document.getElementById("initialMessage");
        const currentPrompt = document.getElementById("currentPrompt");
        const newPromptButton = document.getElementById("newPromptButton");

        const voicePrompts = [
            "Discuss how technology has changed the way we communicate daily...",
            "Describe your favorite memory from childhood in great detail...",
            "Explain the importance of maintaining a healthy work-life balance...",
            "Imagine your ideal vacation destination and describe the atmosphere..."
        ];

        function setStatus(msg, cls = "text-gray-600") {
            statusMessage.textContent = msg;
            statusMessage.className = `font-medium ${cls}`;
        }

        function loadPrompt() {
            currentPrompt.textContent = voicePrompts[Math.floor(Math.random() * voicePrompts.length)];
        }

        // Recognition Setup
        if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
            const SpeechRef = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRef();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onresult = (e) => {
                let text = Array.from(e.results).map(r => r[0].transcript).join('');
                liveCaptionsBox.value = text;
                liveCaptionsBox.scrollTop = liveCaptionsBox.scrollHeight;
            };
        }

        recordButton.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                
                // Force WAV format
                const options = { mimeType: 'audio/webm' };
                mediaRecorder = new MediaRecorder(stream, options);
                
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => processAnalysis(new Blob(audioChunks, { type: "audio/webm" }));

                mediaRecorder.start();
                if (recognition) { liveCaptionsBox.value = ""; recognition.start(); }

                isRecording = true;
                startTime = Date.now();
                recordButton.disabled = true;
                stopButton.disabled = false;
                stopButton.classList.replace("bg-gray-400", "bg-indigo-600");
                setStatus("Recording... Speak clearly.", "recording");

                timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    timerDisplay.textContent = `Time: ${Math.floor(elapsed / 60).toString().padStart(2, "0")}:${(elapsed % 60).toString().padStart(2, "0")}`;
                    if (elapsed >= MIN_DURATION) timerDisplay.classList.add("text-green-600");
                }, 1000);
            } catch (err) { setStatus("Microphone access denied!", "status-error"); }
        };

        stopButton.onclick = () => {
            const elapsed = (Date.now() - startTime) / 1000;
            if (elapsed < MIN_DURATION) {
                alert(`Please record for at least ${MIN_DURATION} seconds.`);
                return;
            }
            mediaRecorder.stop();
            if (recognition) recognition.stop();
            clearInterval(timerInterval);
            isRecording = false;
            stopButton.disabled = true;
            recordButton.disabled = false;
        };
async function processAnalysis(blob) {
    initialMessage.classList.add("hidden");
    loadingSpinner.classList.remove("hidden");
    resultBox.innerHTML = ""; // clear old result

    const formData = new FormData();
    formData.append("audio", blob, "recording.wav");

    try {
        const response = await fetch("/predict_audio", {

            method: "POST",
            body: formData
        });

        // üî¥ IMPORTANT: Handle backend crash / timeout
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        loadingSpinner.classList.add("hidden");

        if (data.error) {
            setStatus(data.error, "status-error");
            return;
        }

        // ‚úÖ SHOW RESULT
        resultBox.classList.remove("hidden");
        resultBox.innerHTML = `
            <h3 class="text-xl font-bold mb-2">Voice Emotion Analysis</h3>
            <p><b>Emotion:</b> ${data.emotion}</p>
            <p><b>Energy:</b> ${Number(data.energy).toFixed(3)}</p>
            <p><b>Pitch:</b> ${Number(data.pitch).toFixed(1)} Hz</p>
            <p class="mt-2 font-semibold text-indigo-700">
                ${data.bipolar_state}
            </p>
        `;

        setStatus("Analysis Complete ‚úî", "text-green-600");

    } catch (err) {
        console.error("‚ùå Fetch error:", err);
        loadingSpinner.classList.add("hidden");

        setStatus(
            "Error: Backend server failed to process audio.",
            "status-error"
        );
    }
}


        newPromptButton.onclick = loadPrompt;
        window.onload = loadPrompt;
    </script>
</body>
</html>
