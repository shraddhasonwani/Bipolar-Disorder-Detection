<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Advanced Facial Emotion Detection</title>\n    <link rel=\"stylesheet\" href=\"{{ url_for('static', filename='style.css') }}\">\n    <style>\n        .camera-container {\n            max-width: 1200px;\n            margin: 20px auto;\n            padding: 20px;\n        }\n        \n        .video-section {\n            display: flex;\n            gap: 20px;\n            margin-bottom: 30px;\n        }\n        \n        .video-container {\n            flex: 1;\n            background: white;\n            border-radius: 15px;\n            padding: 20px;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.1);\n        }\n        \n        #videoElement {\n            width: 100%;\n            max-width: 400px;\n            border-radius: 10px;\n            border: 3px solid #667eea;\n        }\n        \n        .results-container {\n            flex: 1;\n            background: white;\n            border-radius: 15px;\n            padding: 20px;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.1);\n        }\n        \n        .analysis-grid {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 20px;\n            margin-top: 20px;\n        }\n        \n        .analysis-card {\n            background: #f8f9fa;\n            border-radius: 10px;\n            padding: 15px;\n            border-left: 4px solid #667eea;\n        }\n        \n        .au-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n            gap: 10px;\n            margin-top: 15px;\n        }\n        \n        .au-item {\n            background: white;\n            border-radius: 8px;\n            padding: 10px;\n            border: 1px solid #e2e8f0;\n            text-align: center;\n        }\n        \n        .au-item.active {\n            background: #e3f2fd;\n            border-color: #2196f3;\n        }\n        \n        .au-intensity {\n            font-weight: bold;\n            color: #1976d2;\n        }\n        \n        .emotion-badge {\n            display: inline-block;\n            padding: 8px 16px;\n            border-radius: 20px;\n            font-weight: bold;\n            margin: 5px;\n        }\n        \n        .emotion-happy { background: #e8f5e8; color: #2e7d32; }\n        .emotion-sad { background: #ffebee; color: #c62828; }\n        .emotion-neutral { background: #f3f4f6; color: #374151; }\n        .emotion-surprise { background: #fff3e0; color: #f57c00; }\n        .emotion-anger { background: #ffebee; color: #d32f2f; }\n        .emotion-disgust { background: #f1f8e9; color: #689f38; }\n        \n        .risk-indicator {\n            padding: 10px;\n            border-radius: 8px;\n            margin: 10px 0;\n            font-weight: bold;\n        }\n        \n        .risk-low { background: #e8f5e8; color: #2e7d32; }\n        .risk-moderate { background: #fff3e0; color: #f57c00; }\n        .risk-high { background: #ffebee; color: #c62828; }\n        .risk-very-high { background: #ffcdd2; color: #b71c1c; }\n        \n        .control-buttons {\n            text-align: center;\n            margin: 20px 0;\n        }\n        \n        .btn {\n            padding: 12px 24px;\n            margin: 0 10px;\n            border: none;\n            border-radius: 25px;\n            cursor: pointer;\n            font-size: 16px;\n            font-weight: bold;\n            transition: all 0.3s;\n        }\n        \n        .btn-primary {\n            background: #667eea;\n            color: white;\n        }\n        \n        .btn-primary:hover {\n            background: #5a6fd8;\n            transform: translateY(-2px);\n        }\n        \n        .btn-danger {\n            background: #ef4444;\n            color: white;\n        }\n        \n        .btn-danger:hover {\n            background: #dc2626;\n        }\n        \n        .detailed-analysis {\n            background: #f8f9fa;\n            border-radius: 10px;\n            padding: 15px;\n            margin-top: 15px;\n            border-left: 4px solid #10b981;\n        }\n        \n        .pose-info {\n            display: flex;\n            justify-content: space-between;\n            margin: 10px 0;\n        }\n        \n        .pose-item {\n            text-align: center;\n            flex: 1;\n        }\n        \n        .loading {\n            display: none;\n            text-align: center;\n            color: #667eea;\n            font-style: italic;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"camera-container\">\n            <h1 style=\"text-align: center; color: #667eea; margin-bottom: 30px;\">\n                üé≠ Advanced Facial Emotion Detection\n            </h1>\n            \n            <div class=\"video-section\">\n                <div class=\"video-container\">\n                    <h3>Live Camera Feed</h3>\n                    <video id=\"videoElement\" autoplay muted></video>\n                    <canvas id=\"canvas\" style=\"display: none;\"></canvas>\n                    \n                    <div class=\"control-buttons\">\n                        <button id=\"startBtn\" class=\"btn btn-primary\">Start Camera</button>\n                        <button id=\"stopBtn\" class=\"btn btn-danger\" style=\"display: none;\">Stop Camera</button>\n                    </div>\n                    \n                    <div class=\"loading\" id=\"loading\">\n                        Analyzing facial expressions...\n                    </div>\n                </div>\n                \n                <div class=\"results-container\">\n                    <h3>Real-time Analysis Results</h3>\n                    <div id=\"emotionResult\">\n                        <p style=\"color: #666; text-align: center;\">Start camera to begin analysis</p>\n                    </div>\n                </div>\n            </div>\n            \n            <div class=\"analysis-grid\" id=\"analysisGrid\" style=\"display: none;\">\n                <div class=\"analysis-card\">\n                    <h4>üéØ Action Units (OpenFace Style)</h4>\n                    <div id=\"actionUnits\" class=\"au-grid\">\n                        <!-- Action units will be populated here -->\n                    </div>\n                </div>\n                \n                <div class=\"analysis-card\">\n                    <h4>üìä Facial Measurements</h4>\n                    <div id=\"facialMeasurements\">\n                        <!-- Facial measurements will be populated here -->\n                    </div>\n                </div>\n                \n                <div class=\"analysis-card\">\n                    <h4>üëÅÔ∏è Head Pose & Gaze</h4>\n                    <div id=\"headPose\">\n                        <!-- Head pose data will be populated here -->\n                    </div>\n                </div>\n                \n                <div class=\"analysis-card\">\n                    <h4>üß† Bipolar Risk Assessment</h4>\n                    <div id=\"riskAssessment\">\n                        <!-- Risk assessment will be populated here -->\n                    </div>\n                </div>\n            </div>\n            \n            <div class=\"detailed-analysis\" id=\"detailedAnalysis\" style=\"display: none;\">\n                <h4>üîç Detailed Technical Analysis</h4>\n                <div id=\"technicalDetails\">\n                    <!-- Technical details will be populated here -->\n                </div>\n            </div>\n            \n            <div style=\"text-align: center; margin-top: 30px;\">\n                <a href=\"/dashboard\" class=\"btn btn-primary\">‚Üê Back to Dashboard</a>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        let video = document.getElementById('videoElement');\n        let canvas = document.getElementById('canvas');\n        let ctx = canvas.getContext('2d');\n        let stream = null;\n        let analysisInterval = null;\n        \n        document.getElementById('startBtn').addEventListener('click', startCamera);\n        document.getElementById('stopBtn').addEventListener('click', stopCamera);\n        \n        async function startCamera() {\n            try {\n                stream = await navigator.mediaDevices.getUserMedia({ video: true });\n                video.srcObject = stream;\n                \n                document.getElementById('startBtn').style.display = 'none';\n                document.getElementById('stopBtn').style.display = 'inline-block';\n                document.getElementById('analysisGrid').style.display = 'grid';\n                document.getElementById('detailedAnalysis').style.display = 'block';\n                \n                // Start analysis every 2 seconds\n                analysisInterval = setInterval(captureAndAnalyze, 2000);\n                \n            } catch (err) {\n                console.error('Error accessing camera:', err);\n                alert('Unable to access camera. Please check permissions.');\n            }\n        }\n        \n        function stopCamera() {\n            if (stream) {\n                stream.getTracks().forEach(track => track.stop());\n                stream = null;\n            }\n            \n            if (analysisInterval) {\n                clearInterval(analysisInterval);\n                analysisInterval = null;\n            }\n            \n            document.getElementById('startBtn').style.display = 'inline-block';\n            document.getElementById('stopBtn').style.display = 'none';\n            document.getElementById('analysisGrid').style.display = 'none';\n            document.getElementById('detailedAnalysis').style.display = 'none';\n            document.getElementById('loading').style.display = 'none';\n            \n            document.getElementById('emotionResult').innerHTML = '<p style=\"color: #666; text-align: center;\">Camera stopped</p>';\n        }\n        \n        function captureAndAnalyze() {\n            if (!video.videoWidth || !video.videoHeight) return;\n            \n            document.getElementById('loading').style.display = 'block';\n            \n            canvas.width = video.videoWidth;\n            canvas.height = video.videoHeight;\n            ctx.drawImage(video, 0, 0);\n            \n            canvas.toBlob(blob => {\n                const formData = new FormData();\n                formData.append('video_frame', blob, 'frame.jpg');\n                \n                fetch('/api/process_frame', {\n                    method: 'POST',\n                    body: formData\n                })\n                .then(response => response.json())\n                .then(data => {\n                    document.getElementById('loading').style.display = 'none';\n                    displayResults(data);\n                })\n                .catch(error => {\n                    document.getElementById('loading').style.display = 'none';\n                    console.error('Error:', error);\n                    document.getElementById('emotionResult').innerHTML = '<p style=\"color: red;\">Analysis failed. Please try again.</p>';\n                });\n            }, 'image/jpeg', 0.8);\n        }\n        \n        function displayResults(data) {\n            // Main emotion result\n            const emotionClass = getEmotionClass(data.emotion_label);\n            const riskClass = getRiskClass(data.bipolar_risk);\n            \n            document.getElementById('emotionResult').innerHTML = `\n                <div class=\"emotion-badge ${emotionClass}\">${data.emotion_label}</div>\n                <p><strong>Description:</strong> ${data.description}</p>\n                <div class=\"risk-indicator ${riskClass}\">\n                    Bipolar Risk: ${data.bipolar_risk}\n                </div>\n                <p><strong>Confidence:</strong> ${data.confidence}%</p>\n            `;\n            \n            // Action Units\n            displayActionUnits(data.action_units);\n            \n            // Facial Measurements\n            displayFacialMeasurements(data.facial_features);\n            \n            // Head Pose & Gaze\n            displayHeadPose(data.facial_features);\n            \n            // Risk Assessment\n            displayRiskAssessment(data);\n            \n            // Technical Details\n            displayTechnicalDetails(data);\n        }\n        \n        function displayActionUnits(actionUnits) {\n            let html = '';\n            for (const [au, data] of Object.entries(actionUnits)) {\n                const activeClass = data.present ? 'active' : '';\n                html += `\n                    <div class=\"au-item ${activeClass}\">\n                        <div><strong>${au}</strong></div>\n                        <div style=\"font-size: 12px; color: #666;\">${data.name}</div>\n                        <div class=\"au-intensity\">${data.intensity.toFixed(1)}</div>\n                        <div style=\"font-size: 11px;\">${data.present ? 'Active' : 'Inactive'}</div>\n                    </div>\n                `;\n            }\n            document.getElementById('actionUnits').innerHTML = html;\n        }\n        \n        function displayFacialMeasurements(features) {\n            document.getElementById('facialMeasurements').innerHTML = `\n                <p><strong>Face Detected:</strong> ${features.face_detected ? 'Yes' : 'No'}</p>\n                <p><strong>Eyes Detected:</strong> ${features.eyes_detected}</p>\n                <p><strong>Eye Openness:</strong> ${features.eye_openness.toFixed(1)}</p>\n                <p><strong>Face Area Ratio:</strong> ${(features.face_area_ratio * 100).toFixed(2)}%</p>\n                <p><strong>Brightness:</strong> ${features.brightness.toFixed(1)}</p>\n                <p><strong>Contrast:</strong> ${features.contrast.toFixed(1)}</p>\n                <p><strong>Emotion Intensity:</strong> ${features.emotion_intensity.toFixed(2)}</p>\n            `;\n        }\n        \n        function displayHeadPose(features) {\n            document.getElementById('headPose').innerHTML = `\n                <div class=\"pose-info\">\n                    <div class=\"pose-item\">\n                        <div><strong>Pitch</strong></div>\n                        <div>${features.head_pose.pitch.toFixed(1)}¬∞</div>\n                    </div>\n                    <div class=\"pose-item\">\n                        <div><strong>Yaw</strong></div>\n                        <div>${features.head_pose.yaw.toFixed(1)}¬∞</div>\n                    </div>\n                    <div class=\"pose-item\">\n                        <div><strong>Roll</strong></div>\n                        <div>${features.head_pose.roll.toFixed(1)}¬∞</div>\n                    </div>\n                </div>\n                <hr>\n                <p><strong>Gaze Direction:</strong></p>\n                <p>X: ${features.gaze.direction_x.toFixed(2)}, Y: ${features.gaze.direction_y.toFixed(2)}</p>\n                <p><strong>Gaze Angle:</strong></p>\n                <p>X: ${features.gaze.angle_x.toFixed(1)}¬∞, Y: ${features.gaze.angle_y.toFixed(1)}¬∞</p>\n            `;\n        }\n        \n        function displayRiskAssessment(data) {\n            const riskClass = getRiskClass(data.bipolar_risk);\n            let symptomsHtml = data.symptoms.map(symptom => `<li>${symptom}</li>`).join('');\n            let recommendationsHtml = data.recommendations.map(rec => `<li>${rec}</li>`).join('');\n            \n            document.getElementById('riskAssessment').innerHTML = `\n                <div class=\"risk-indicator ${riskClass}\">\n                    Risk Level: ${data.bipolar_risk}\n                </div>\n                <p><strong>Symptoms:</strong></p>\n                <ul>${symptomsHtml}</ul>\n                <p><strong>Recommendations:</strong></p>\n                <ul>${recommendationsHtml}</ul>\n            `;\n        }\n        \n        function displayTechnicalDetails(data) {\n            document.getElementById('technicalDetails').innerHTML = `\n                <p><strong>ML Prediction:</strong> ${data.prediction} (${data.prediction === 0 ? 'Normal/Euthymic' : 'Elevated/Manic'})</p>\n                <p><strong>Model Probabilities:</strong></p>\n                <ul>\n                    <li>Normal/Euthymic: ${data.probabilities.normal_euthymic}%</li>\n                    <li>Manic/Elevated: ${data.probabilities.manic_elevated}%</li>\n                </ul>\n                <p><strong>Detailed Analysis:</strong></p>\n                <p style=\"font-style: italic; color: #555;\">${data.detailed_analysis}</p>\n            `;\n        }\n        \n        function getEmotionClass(emotion) {\n            if (emotion.toLowerCase().includes('happy') || emotion.toLowerCase().includes('joy')) return 'emotion-happy';\n            if (emotion.toLowerCase().includes('sad') || emotion.toLowerCase().includes('depression')) return 'emotion-sad';\n            if (emotion.toLowerCase().includes('surprise')) return 'emotion-surprise';\n            if (emotion.toLowerCase().includes('anger') || emotion.toLowerCase().includes('irritation')) return 'emotion-anger';\n            if (emotion.toLowerCase().includes('disgust')) return 'emotion-disgust';\n            return 'emotion-neutral';\n        }\n        \n        function getRiskClass(risk) {\n            if (risk.toLowerCase().includes('very high')) return 'risk-very-high';\n            if (risk.toLowerCase().includes('high')) return 'risk-high';\n            if (risk.toLowerCase().includes('moderate')) return 'risk-moderate';\n            return 'risk-low';\n        }\n    </script>\n</body>\n</html>